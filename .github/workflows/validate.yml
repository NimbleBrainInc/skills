name: Validate Skills

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate skills
        uses: NimbleBrainInc/skill-pack@v1
        with:
          build: false
          upload: false
          announce: false

      - name: Validate against registry schema
        run: |
          # Fetch the skill frontmatter schema from OpenAPI docs
          SCHEMA=$(curl -s https://api.mpak.dev/docs/json | \
            jq '.paths["/v1/skills/announce"].post.requestBody.content["application/json"].schema.properties.skill')

          if [ "$SCHEMA" = "null" ] || [ -z "$SCHEMA" ]; then
            echo "::error::Failed to fetch schema from API"
            exit 1
          fi

          echo "$SCHEMA" > /tmp/skill-schema.json
          echo "Fetched skill frontmatter schema from registry"

          # Install ajv-cli for JSON Schema validation
          npm install -g ajv-cli ajv-formats

          ERRORS=0

          # Validate each skill's frontmatter
          for dir in */; do
            if [ -f "$dir/SKILL.md" ]; then
              SKILL="${dir%/}"
              echo "Validating $SKILL..."

              # Extract YAML frontmatter and convert to JSON
              FRONTMATTER=$(awk '/^---$/{if(f){exit}f=1;next}f' "$dir/SKILL.md" | yq -o=json '.')

              if [ -z "$FRONTMATTER" ] || [ "$FRONTMATTER" = "null" ]; then
                echo "::error file=$dir/SKILL.md::No valid frontmatter found"
                ERRORS=$((ERRORS + 1))
                continue
              fi

              echo "$FRONTMATTER" > /tmp/frontmatter.json

              # Validate against schema
              if ! ajv validate -s /tmp/skill-schema.json -d /tmp/frontmatter.json --spec=draft2020 --strict=false 2>&1; then
                echo "::error file=$dir/SKILL.md::Schema validation failed"
                ERRORS=$((ERRORS + 1))
              else
                echo "âœ“ $SKILL passed validation"
              fi
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo "::error::$ERRORS skill(s) failed validation"
            exit 1
          fi

          echo "All skills passed registry schema validation"
